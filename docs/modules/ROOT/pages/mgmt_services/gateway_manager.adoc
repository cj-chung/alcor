= Gateway Manager Design Specification
v0.1, 2020-12-20
:toc: right
:imagesdir: ../../images

NOTE: This document is under development

== Overview
The Gateway Manager is an Alcor microservice which manages the internal gateway and external gateway resources for a VPC.
The external gateways are responsible for forwarding traffic to/from external networks, such as another VPC, Internet, on-premise datacenter.
The external gateway including Internet Gateway, NAT Gateway, VPN Gateway and Transit Gateway.
The internal gateway handles internal traffic within a VPC. Zeta Gateway is the only internal gateway in the current Gateway Manager.
Gateway Manager's responsibilities include but are not limited to create, update, delete, and search gateway resources for VPC.
It interacts with VPC Manager, Port Manager, Data Plane Manager, and Gateway Clusters.

== Service Requirements
[arabic]
. Manage different types of gateways for a VPC, including internal and external gateways, such as Zeta Gateway, Internet Gateway, NAT Gateway, VPN Gateway and Transit Gateway.
. Expose CURD APIs to register, update, query and delete VPC's gateway mappings.
. Define a health model, data schema and APIs for the health status of gateway resources.
. Working together with other services including VPC, Route, Port, Data Plane managers.
. Rollback is supported when CRUD operation occurs exception or the exceptions from gateway resources.

== Design
=== Service Architecture
image::gateway_manager_service_architecture.PNG[]

=== Data Schema
Two options for gateway data schema design: coupled and de-coupled.
Option A is a coupled design, gateway entity is coupled with a VPC. Option B is a de-coupled design.
Gateway, VPC and routing table resources are all de-coupled.
Option B is more flexible design, it fits to all different types of gateways.

*OPTION A*

image::gateway_manager_data_schema.PNG[]

*OPTION B*

image::gateway_manager_data_schema_decoupled.PNG[]

*Zeta Gateway Example*

image::gateway_manager_zeta_gateway_example_schema.PNG[]

*Transit Gateway Example 1*

image::gateway_manager_transit_gateway_example1_figure.PNG[]
image::gateway_manager_transit_gateway_example1_schema.PNG[]

*Transit Gateway Example 2*

image::gateway_manager_transit_gateway_example2_figure.PNG[]
image::gateway_manager_transit_gateway_example2_schema.PNG[]

=== Key Workflow
We have two options here for VPC and gateway resource creation.
The major difference of these two option is in A1 and B1.
The VPC registration for gateway resource in A1 is going through DPM
while the same process in B1 is going through GM. Both A2 and B2 workflows are pretty much the same.
The detail workflows of two options are below:

*OPTION A*

==== A1. VPC and Zeta Gateway Creation
1. The benefit of A1: GM can be decoupled from major components of Alcor, we can consider GM is a non-major component.
2. The drawback of A1: DPM becomes a proactive component, and it needs to update GM actively.

image::gateway_manager_vpc_zetagateway_creation_A.PNG[]

==== A2. Port Creation
image::gateway_manager_zeta_port_creation_A.PNG[]

*OPTION B*

==== B1. VPC and Zeta Gateway Creation
1. The benefit of B1: DPM becomes a passive component, it just needs to wait for the status update of gateway resources from GM.
GM is the major resource holder for gateway resources.

image::gateway_manager_vpc_zetagateway_creation_B.PNG[]

==== B2. Port Creation
image::gateway_manager_zeta_port_creation_B.PNG[]

*FINAL DECISION*
Option A has more benefit for managing gateway resources.
GM will become an important microservice in Alcor to manage all types of gateways in the future.
Therefore, Option A is the design choice for GM.

== REST APIs
[width="100%",cols="32%,12%,40%,17%"]
|===
|*API Name* |*Method* |*Request*|*Response*

|Register a VPC for Zeta Gateway
|POST
|/project/{projectid}/vpcs/{vpc_id}/zetagateway
|VPC's GatewayInfo ID
<<vpc_zgw_register,[sample]>>

|Update VPC's Zeta gateway
|PUT
|/project/{projectid}/vpcs/{vpc_id}/zetagateway
|Gateway state
<<vpc_zgw_update,[sample]>>

|Update a gateway by ID
|PUT
|/project/{projectid}/vpcs/{vpc_id}/gateway/{gateway_id}
|Gateway state
<<vpc_gw_update_id,[sample]>>

|Query gateway's state
|GET
|/project/{projectid}/vpcs/{vpc_id}/gateway/{gateway_id}
|Gateway state
<<gw_get,[sample]>>

|List VPC's Available Gateways
|GET
|/project/{projectid}/vpcs/{vpc_id}/gateways
|All gateways' state
<<gws_get_all,[sample]>>

|Delete a gateway
|DELETE
|/project/{projectid}/vpcs/{vpc_id}/gateway/{gateway_id}
|ResponseId
<<gw_del,[sample]>>
|===

=== API Specification

anchor:vpc_zgw_register[]
**(1) Register a VPC for Zeta Gateway**

* Method: `POST`
* Request: `/project/{projectid}/vpcs/{vpc_id}/zetagateway`
* Request Parameter: `@PathVariable String projectid, @PathVariable String vpc_id`
* Operation: Create a GatewayInfo entity in Gateway Manager's database.
If the project is a zeta-gateway enabled (by admin or tenant), perform following actions:
1. Create a *GatewayEntity* with "zeta" type and set its status to _PENDING_
2. Create a *GWAttachment* with *VpcInfo* for the VPC and attach it to the gateway entity.
3. Send a *GatewayInfo* to Data Plane Manager and save the entity to DPM's cache
** If DPM returns failed, retry three times
** If the retry still failed, rollback GM's DB transaction and notify Zeta Management Plane to release the created gateway resource
4. Request Zeta Management Plane to create a gateway resource for the VPC (step 3 and step 4 can be paralleled)
** If step 4 returns success, set zeta gateway status to READY and Update DPM’s cache
** If step 4 returns failed, set zeta gateway status to FAILED and Update DPM’s cache
* Response: VPC ID
* Normal response codes: 200
* Error response codes: 400, 401, 404, 500
* Example
....
Request:
http://localhost:8080/project/3dda2801-d675-4688-a63f-dcda8d327f50/vpcs/ae34051f-aa6c-4c75-abf5-50dc9ac99ef3/zetagateway

Body:
{
    "vpcinfo": {
        "vpc_vni": 1233,
        "owner": "3dda2801-d675-4688-a63f-dcda8d327f50"
    }
}
....

anchor:vpc_zgw_update[]
**(2) Update VPC's Zeta gateway**

* Method: `PUT`
* Request: `/project/{projectid}/vpcs/{vpc_id}/zetagateway`
* Request Parameter: `@PathVariable String projectid, @PathVariable String vpc_id`
* Operation: Update a VPC's Zeta Gateway status.
If the request body contains a zeta gateway entity, perform following actions:
1. Retrieve the GWAttachment entity with _vpc_id_.
2. Retrieve the GatewayEntity with the _gateway_id_ in the GWAttachment.
3. Update GatewayEntity's status
* Response: VPC ID
* Normal response codes: 200
* Error response codes: 400, 401, 404, 500
* Example
....
Request:
http://localhost:8080/project/3dda2801-d675-4688-a63f-dcda8d327f50/vpcs/ae34051f-aa6c-4c75-abf5-50dc9ac99ef3/zetagateway

Body:
{
    "gatewayinfo": {
        "resource_id": "ae34051f-aa6c-4c75-abf5-50dc9ac99ef3",
        "gateways": [
            {
                "type": "zeta",
                "status": "failed"
            }
        ]
    }
}
....